name: Validate Plugins

on:
  push:
    branches: [main]
    paths:
      - 'plugins/**'
  pull_request:
    branches: [main]
    paths:
      - 'plugins/**'

jobs:
  detect-changes:
    name: Detect changed plugins
    runs-on: ubuntu-latest
    outputs:
      plugins: ${{ steps.changes.outputs.plugins }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed plugin folders
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE=${{ github.event.pull_request.base.sha }}
          else
            BASE=${{ github.event.before }}
          fi

          CHANGED=$(git diff --name-only "$BASE" HEAD \
            | grep '^plugins/' \
            | cut -d'/' -f2 \
            | sort -u \
            | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "plugins=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "Changed plugins: $CHANGED"

  validate:
    name: Validate ${{ matrix.plugin }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.plugins != '[]'
    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJson(needs.detect-changes.outputs.plugins) }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: plugins/${{ matrix.plugin }}/package-lock.json

      - name: Check plugin structure
        run: |
          PLUGIN="plugins/${{ matrix.plugin }}"

          echo "Checking structure for $PLUGIN..."

          if [ ! -f "$PLUGIN/README.md" ]; then
            echo "❌ Missing README.md"
            exit 1
          fi

          if [ ! -f "$PLUGIN/package.json" ]; then
            echo "❌ Missing package.json"
            exit 1
          fi

          if [ ! -f "$PLUGIN/tsconfig.json" ]; then
            echo "❌ Missing tsconfig.json"
            exit 1
          fi

          if [ ! -f "$PLUGIN/src/index.ts" ]; then
            echo "❌ Missing src/index.ts"
            exit 1
          fi

          echo "✅ Structure OK"

      - name: Install dependencies
        working-directory: plugins/${{ matrix.plugin }}
        run: npm ci

      - name: TypeScript check
        working-directory: plugins/${{ matrix.plugin }}
        run: npx tsc --noEmit

      - name: Check compiled output exists
        run: |
          PLUGIN_ID="${{ matrix.plugin }}"
          DIST="plugins/$PLUGIN_ID/dist/$PLUGIN_ID.js"

          if [ ! -f "$DIST" ]; then
            echo "❌ Compiled output missing: $DIST"
            echo "Run 'npx tsc' in the plugin folder and commit the dist/ output."
            exit 1
          fi

          echo "✅ Compiled output found: $DIST"

      - name: Security checks
        working-directory: plugins/${{ matrix.plugin }}
        run: |
          echo "Checking for common security issues..."

          # Check for hardcoded secrets patterns
          if grep -rn \
            -e "password\s*=\s*['\"][^'\"]\+['\"]" \
            -e "api_key\s*=\s*['\"][^'\"]\+['\"]" \
            -e "secret\s*=\s*['\"][^'\"]\+['\"]" \
            src/ 2>/dev/null; then
            echo "❌ Possible hardcoded credentials found. Review the above lines."
            exit 1
          fi

          # Warn about console.log that might leak data
          COUNT=$(grep -rn "console\.log" src/ 2>/dev/null | wc -l)
          if [ "$COUNT" -gt 0 ]; then
            echo "⚠️  Found $COUNT console.log statement(s) — make sure none log credentials or sensitive data."
          fi

          echo "✅ No obvious hardcoded secrets found"

      - name: Check requiresApproval on write tools
        working-directory: plugins/${{ matrix.plugin }}
        run: |
          echo "Checking requiresApproval on write/delete tools..."

          # Look for tools with write-like names that might be missing requiresApproval
          python3 - << 'EOF'
          import re, sys

          with open('src/index.ts', 'r') as f:
              content = f.read()

          # Find tool blocks
          tool_pattern = re.compile(
              r"name:\s*['\"]([^'\"]+)['\"].*?(?=name:\s*['\"]|\Z)",
              re.DOTALL
          )
          
          write_keywords = ['send', 'create', 'delete', 'update', 'post', 'write', 
                            'remove', 'set', 'toggle', 'add', 'upload', 'modify']
          
          warnings = []
          for m in tool_pattern.finditer(content):
              tool_block = m.group(0)
              tool_name = m.group(1)
              is_write = any(kw in tool_name.lower() for kw in write_keywords)
              has_approval = 'requiresApproval' in tool_block and 'true' in tool_block
              
              if is_write and not has_approval:
                  warnings.append(f"  ⚠️  {tool_name} looks like a write operation but may be missing requiresApproval: true")
          
          if warnings:
              print('\n'.join(warnings))
              print('\nConsider adding requiresApproval: true to these tools.')
          else:
              print('✅ requiresApproval check passed')
          EOF
